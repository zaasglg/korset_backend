# Регистрация с подтверждением телефона

## Процесс регистрации

Регистрация происходит в 2 этапа:
1. **Отправка кода** - пользователь вводит данные и получает SMS код подтверждения
2. **Подтверждение** - пользователь вводит код и завершает регистрацию

**Важно:** Приветственные SMS не отправляются. Отправляется только код подтверждения.

## API Endpoints

### 1. Отправка кода подтверждения

**POST** `/api/send-verification-code`

**Body:**
```json
{
    "phone_number": "+77001234567",
    "name": "Тестовый Пользователь",
    "email": "test@example.com",
    "password": "password123",
    "password_confirmation": "password123",
    "referral_code": null
}
```

**Успешный ответ:**
```json
{
    "success": true,
    "message": "Код подтверждения отправлен на номер +77001234567",
    "expires_at": "2025-08-07 19:15:00",
    "expires_in_seconds": 300
}
```

**Ошибки:**
```json
{
    "success": false,
    "error": "Номер телефона уже зарегистрирован"
}
```

### 2. Подтверждение кода и завершение регистрации

**POST** `/api/verify-and-register`

**Body:**
```json
{
    "phone_number": "+77001234567",
    "code": "123456"
}
```

**Успешный ответ:**
```json
{
    "success": true,
    "message": "Регистрация успешно завершена",
    "user": {
        "id": 1,
        "name": "Тестовый Пользователь",
        "email": "test@example.com",
        "phone_number": "+77001234567",
        "created_at": "2025-08-07T19:10:00.000000Z"
    },
    "token": "1|abc123..."
}
```

**Ошибки:**
```json
{
    "success": false,
    "error": "Неверный код подтверждения"
}
```

### 3. Проверка статуса верификации

**POST** `/api/verification-status`

**Body:**
```json
{
    "phone_number": "+77001234567"
}
```

**Ответы:**
```json
// Код не запрашивался
{
    "status": "not_requested",
    "message": "Код не запрашивался"
}

// Ожидается подтверждение
{
    "status": "pending",
    "message": "Ожидается подтверждение",
    "expires_at": "2025-08-07 19:15:00",
    "remaining_seconds": 240
}

// Код истек
{
    "status": "expired",
    "message": "Код истек"
}

// Номер подтвержден
{
    "status": "verified",
    "message": "Номер подтвержден",
    "verified_at": "2025-08-07 19:12:00"
}
```

## Тестирование в Postman

### Шаг 1: Отправка кода
1. **POST** `http://127.0.0.1:8000/api/send-verification-code`
2. **Headers:** `Content-Type: application/json`
3. **Body:** JSON с данными регистрации

### Шаг 2: Проверка SMS
Код придет на указанный номер телефона

### Шаг 3: Подтверждение
1. **POST** `http://127.0.0.1:8000/api/verify-and-register`
2. **Body:** номер телефона и полученный код

## Особенности

### Защита от спама
- Повторный запрос кода возможен только через 4 минуты
- Код действует 5 минут
- Автоматическая очистка истекших кодов

### Безопасность
- Данные регистрации временно хранятся зашифрованными
- Код можно использовать только один раз
- Проверка уникальности email/телефона на каждом этапе

### Логирование
- Все SMS логируются в базу данных
- Отслеживание статуса верификации
- Детальные логи ошибок

## Команды для управления

```bash
# Очистка истекших верификаций
php artisan verification:clean

# Проверка баланса SMS
php artisan sms:balance

# Тестовая отправка SMS
php artisan sms:test +77001234567
```

## Обратная совместимость

Старый endpoint `/api/register` теперь автоматически перенаправляет на новый процесс с подтверждением телефона.